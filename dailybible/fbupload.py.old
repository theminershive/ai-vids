#!/usr/bin/env python3
from pathlib import Path
import sys
import os
import requests
import json
import logging
from dotenv import load_dotenv

load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

USER_ACCESS_TOKEN = os.getenv('USER_ACCESS_TOKEN')
FACEBOOK_PAGE_ID = os.getenv('FACEBOOK_PAGE_ID')
GRAPH_API_BASE = 'https://graph.facebook.com'

def get_page_access_token():
    """Fetch a Page access token using the USER_ACCESS_TOKEN."""
    if not USER_ACCESS_TOKEN:
        logging.error("USER_ACCESS_TOKEN not set.")
        sys.exit(1)
    url = f"{GRAPH_API_BASE}/v21.0/me/accounts"
    resp = requests.get(url, params={'access_token': USER_ACCESS_TOKEN})
    if resp.status_code != 200:
        logging.error(f"Failed to fetch pages: {resp.text}")
        sys.exit(1)
    for page in resp.json().get('data', []):
        if str(page.get('id')) == FACEBOOK_PAGE_ID:
            token = page.get('access_token')
            logging.info("Using Page access token.")
            return token
    logging.error("Page ID not found in /me/accounts.")
    sys.exit(1)

def upload(json_path):
    """Upload final_video from JSON to Facebook Page videos endpoint."""
    if not FACEBOOK_PAGE_ID:
        logging.error("FACEBOOK_PAGE_ID not set.")
        sys.exit(1)
    if not os.path.exists(json_path):
        logging.error(f"JSON file not found: {json_path}")
        sys.exit(1)

    page_token = get_page_access_token()

    with open(json_path) as f:
        metadata = json.load(f)

    video_file = metadata.get('final_video')
    social = metadata.get('social_media', {})
    title = social.get('title', '')
    description = social.get('description', '')

    # Append YouTube link if present
    yt_url = next((p for p in description.split() if p.startswith('https://youtu')), None)
    if yt_url:
        description = f"{description}\n\nWatch on YouTube: {yt_url}"

    if not video_file or not os.path.exists(video_file):
        logging.error(f"Video file not found: {video_file}")
        sys.exit(1)

    logging.info(f"Uploading video: {video_file}")
    url = f"{GRAPH_API_BASE}/v21.0/{FACEBOOK_PAGE_ID}/videos"
    data = {
        'title': title,
        'description': description,
        'published': 'true',
        'temporary': 'true',
        'access_token': page_token
    }
    files = {'source': open(video_file, 'rb')}
    resp = requests.post(url, data=data, files=files)
    if resp.status_code != 200:
        logging.error(f"Upload failed: {resp.status_code} {resp.text}")
        sys.exit(1)

    logging.info("Facebook video upload succeeded.")
    print(json.dumps(resp.json(), indent=2))

if __name__ == '__main__':
    if len(sys.argv) > 1:
        # Command line argument provided
        json_path = Path(sys.argv[1])
        if not json_path.exists():
            logging.error(f"Specified JSON file does not exist: {json_path}")
            sys.exit(1)
        upload(json_path)
    else:
        # No argument, auto-select latest
        ready_dir = Path('ready')
        json_files = list(ready_dir.glob('*.json'))
        if not json_files:
            logging.error("No JSON files found in ready directory.")
            sys.exit(1)
        latest_json = max(json_files, key=lambda p: p.stat().st_mtime)
        upload(latest_json)
